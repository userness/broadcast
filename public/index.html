<!DOCTYPE html>
<html>
<head>
  <title>Live Voice Chat</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    .user { margin: 5px; padding: 5px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Live Voice Chat</h1>
  <p>Join instantly. Your voice is live to everyone here.</p>
  <div id="users"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const peers = {};
    const localAudio = document.createElement('audio');
    localAudio.muted = true;

    // Auto-start microphone
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        localAudio.srcObject = stream;
        localAudio.play();

        // Handle peer connections
        socket.on('signal', async ({ from, signal }) => {
          if (!peers[from]) connectToNewUser(from, false, stream);
          peers[from].signal(signal);
        });

        socket.on('user-disconnected', id => {
          if (peers[id]) peers[id].destroy();
          delete peers[id];
        });

        // Connect to all existing users
        socket.on('existing-users', users => {
          users.forEach(userId => connectToNewUser(userId, true, stream));
        });
      })
      .catch(console.error);

    function connectToNewUser(userId, initiator, stream) {
      const peer = new SimplePeer({ initiator, trickle: false, stream });

      peer.on('signal', signal => {
        socket.emit('signal', { to: userId, signal });
      });

      peer.on('stream', remoteStream => {
        const audio = document.createElement('audio');
        audio.srcObject = remoteStream;
        audio.autoplay = true;
        audio.controls = true;
        document.getElementById('users').appendChild(audio);
      });

      peer.on('close', () => {
        peer.destroy();
      });

      peers[userId] = peer;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
</body>
</html>
